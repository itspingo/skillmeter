{% extends "base.html" %}
{% block title %}Take Test{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    <div class="w-1/3 bg-black flex flex-col">
        <div class="p-4 bg-gray-900 text-white flex justify-between items-center">
            <h3 class="font-bold">Test Monitoring</h3>
            <div id="timer" class="text-xl font-mono bg-red-600 px-3 py-1 rounded">00:00</div>
        </div>
        <div class="flex-1 relative">
            <video id="camera" autoplay muted class="w-full h-full object-cover"></video>
            <div class="absolute bottom-4 left-0 right-0 flex justify-center">
                <div class="bg-black bg-opacity-50 text-white px-4 py-2 rounded">
                    <span id="recording-indicator" class="inline-block w-3 h-3 bg-red-600 rounded-full mr-2"></span>
                    Recording
                </div>
            </div>
        </div>
    </div>

    <div class="w-2/3 p-6 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">{{test.name}}</h2>
            <p class="text-gray-600 mb-4">{{ test.description }}</p>
            <div class="flex items-center text-sm text-gray-500">
                <span class="mr-4">Questions: {{ test.questions|length }}</span>
                {% if test.time_limit %}
                <span>Time Limit: {{ test.time_limit }} minutes</span>
                {% endif %}
            </div>
        </div>

        <form action="{{ url_for('submit_test') }}" method="POST" id="test-form" class="space-y-6">
            <input type="hidden" name="attempt_id" value="{{ attempt_id }}">
            
            {% for question in test.questions %}
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 question-container" data-question-id="{{ question.id }}" data-question-index="{{ loop.index0 }}" style="display: none;">
                <div class="flex items-start mb-4">
                    <span class="bg-blue-100 text-blue-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded">Question {{ loop.index }}</span>
                    <p class="font-semibold text-gray-800">{{ question.question }}</p>
                </div>
                
                <div class="space-y-3 ml-6">
                    {% for option in question.options %}
                    <div class="flex items-center">
                        <input type="radio" id="question_{{ question.id }}_{{ loop.index }}" name="question_{{ question.id }}" value="{{ option }}" class="hidden peer">
                        <label for="question_{{ question.id }}_{{ loop.index }}" class="w-full p-3 border border-gray-300 rounded-lg cursor-pointer peer-checked:border-blue-600 peer-checked:bg-blue-50 hover:bg-gray-50 transition-colors duration-200 flex items-start">
                            <span class="inline-block w-5 h-5 rounded-full border border-gray-400 mr-3 mt-0.5 peer-checked:border-blue-600 peer-checked:bg-blue-600 peer-checked:bg-center peer-checked:bg-no-repeat peer-checked:bg-[length:10px] peer-checked:bg-[url('data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxMiIgaGVpZ2h0PSIxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cG9seWxpbmUgcG9pbnRzPSIyMCA2IDkgMTcgNCAxMiI+PC9wb2x5bGluZT48L3N2Zz4=')]"></span>
                            <span>{{ option }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            
            <div class="sticky bottom-0 bg-white p-4 border-t border-gray-200 shadow-lg flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <button type="button" id="prev-btn" class="px-6 py-3 rounded-lg font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200" style="display: none;">Previous</button>
                    <button type="button" id="next-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 font-medium">Next</button>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="current-question-indicator">1</span> of {{ test.questions|length }}
                </div>
                <div>
                    <button type="submit" id="submit-btn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors duration-200 font-medium" style="display: none;">
                        Submit Test
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Camera setup (unchanged)
    const video = document.getElementById('camera');
    const recordingIndicator = document.getElementById('recording-indicator');
    if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        })
        .then(function (stream) {
            video.srcObject = stream;
            setInterval(() => {
                recordingIndicator.classList.toggle('bg-red-400');
            }, 1000);
        })
        .catch(function (error) {
            console.log("Camera access error:", error);
            recordingIndicator.classList.add('bg-gray-500');
            recordingIndicator.classList.remove('bg-red-600');
        });
    }

    // Timer functionality (unchanged)
    const timerElement = document.getElementById('timer');
    const timeLimit = {{ test.time_limit }} * 60 || 60 * 60;
    let timeRemaining = timeLimit;
    function updateTimer() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Submitting your test.');
            document.getElementById('test-form').submit();
        } else if (timeRemaining <= 300) {
            timerElement.classList.add('bg-red-800');
        }
        timeRemaining--;
    }
    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();

    // Single question navigation
    const questionContainers = document.querySelectorAll('.question-container');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const submitBtn = document.getElementById('submit-btn');
    const currentQuestionIndicator = document.getElementById('current-question-indicator');

    let currentQuestionIndex = 0;

    function showQuestion(index) {
        questionContainers.forEach(container => container.style.display = 'none');
        questionContainers[index].style.display = 'block';
        currentQuestionIndicator.textContent = index + 1;
        updateButtons();
    }

    function updateButtons() {
        if (currentQuestionIndex === 0) {
            prevBtn.style.display = 'none';
        } else {
            prevBtn.style.display = 'block';
        }

        if (currentQuestionIndex === questionContainers.length - 1) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }
    }

    nextBtn.addEventListener('click', () => {
        if (currentQuestionIndex < questionContainers.length - 1) {
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showQuestion(currentQuestionIndex);
        }
    });

    // Initial load
    showQuestion(currentQuestionIndex);
    
    // Prevent accidental refresh/navigation (unchanged)
    window.addEventListener('beforeunload', function (e) {
        if (timeRemaining > 0) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        }
    });
</script>
{% endblock %}